<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ch√° da Suelen</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f0f2f5;
            --header: #2c3e50;
            --white: #fff;
            --green: #27ae60; --red: #c0392b; --blue: #2980b9; --orange: #f39c12;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: #333; }

        /* Login */
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #2c3e50, #3498db); }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; }

        /* Painel */
        header { background: var(--header); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        @media(max-width:768px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: var(--header); }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .tag-livre { background: #eafaf1; color: var(--green); }
        .tag-ocupado { background: #ebf5fb; color: var(--blue); }

        /* Bot√µes */
        .btn { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; color: white; font-weight: 500; font-size: 0.85rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--blue); width: 100%; }
        .btn-warning { background: var(--orange); }
        .btn-danger { background: var(--red); }
        
        #loading { text-align: center; color: #666; margin: 20px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>üîí Admin</h2>
            <input type="password" id="admin-pass" placeholder="Senha...">
            <button class="btn btn-primary" onclick="login()">Entrar</button>
        </div>
    </div>

    <div id="admin-panel" style="display: none;">
        <header>
            <h3>üõ†Ô∏è Controle Planilha</h3>
            <div style="display:flex; align-items:center; gap:8px;">
                <button id="update-btn" onclick="refreshSheet()" style="background:transparent; border:1px solid rgba(255,255,255,0.18); color:white; padding:6px 10px; border-radius:6px; cursor:pointer;">Atualizar</button>
                <button id="test-btn" onclick="testScript()" style="background:transparent; border:1px solid rgba(255,255,255,0.12); color:white; padding:6px 10px; border-radius:6px; cursor:pointer;">Testar Conex√£o</button>
                <button onclick="location.reload()" style="background:none; border:none; color:white; cursor:pointer;">Sair</button>
            </div>
        </header>

        <div class="container">
            <div class="dashboard-grid">
                
                <div>
                    <div class="card">
                        <h3>‚ûï Novo Item</h3>
                        <div class="form-group">
                            <label>Nome do Item</label>
                            <input type="text" id="new-name" placeholder="Ex: Panela Wok">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="new-type">
                                <option value="presente">üéÅ Presente</option>
                                <option value="comida">üç© Comida</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addItem()">Adicionar na Planilha</button>
                    </div>

                    <div class="card">
                        <h3>üìä Status</h3>
                        <p>Total: <strong id="stat-total">0</strong></p>
                        <p>Doados: <strong id="stat-taken" style="color:var(--blue)">0</strong></p>
                        <p>Livres: <strong id="stat-free" style="color:var(--green)">0</strong></p>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3>üìã Lista Completa</h3>
                        <div id="loading">Carregando dados da planilha...</div>
                        <table id="items-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Doador</th>
                                    <th style="text-align:right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- SEU NOVO SCRIPT GOOGLE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-mGLV66ZBe4pRtIm6W8OHKJlkOCnEeT6ln_B7bh_S79xSFefNgiv2k0g14flwpDH5/exec";
        const SENHA_ADMIN = "camila321"; // Senha de acesso
        // -------------------------------

        let allData = [];

        function login() {
            if (document.getElementById('admin-pass').value === SENHA_ADMIN) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                fetchData();
            } else {
                alert("Senha errada!");
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                allData = data;
                renderTable();
                updateStats();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Erro em fetchData:', error);
                // Mensagem mais detalhada para o usu√°rio
                let msg = 'Erro ao ler planilha. Verifique se o link est√° correto e se o Apps Script est√° implantado como Web App (acesso: qualquer pessoa).';
                msg += '\n\nPoss√≠veis causas:\n- URL inv√°lida\n- App Script n√£o implantado como "Anyone, even anonymous" ou similar\n- Problemas de CORS bloqueando a requisi√ß√£o (veja o console do navegador)\n- Resposta do servidor n√£o √© JSON v√°lido\n\nAbra o console do navegador (F12) para mais detalhes.';
                alert(msg);
            }
        }

        async function sendAction(payload) {
            document.body.style.cursor = 'wait';
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                setTimeout(() => {
                    fetchData();
                    alert("A√ß√£o enviada com sucesso!");
                    document.body.style.cursor = 'default';
                }, 1500);

            } catch (error) {
                alert("Erro ao enviar comando.");
                document.body.style.cursor = 'default';
            }
        }

        // --- A√á√ïES ---
        function addItem() {
            const nome = document.getElementById('new-name').value;
            const tipo = document.getElementById('new-type').value;
            if(!nome) return alert("Digite o nome!");
            sendAction({ action: 'admin_add', nome: nome, tipo: tipo });
            document.getElementById('new-name').value = '';
        }

        function resetItem(id) {
            if(confirm("Tem certeza? Isso vai apagar o nome do doador.")) {
                sendAction({ action: 'admin_reset', id: id });
            }
        }

        function deleteItem(id) {
            if(confirm("Isso vai EXCLUIR a linha da planilha para sempre. Confirma?")) {
                sendAction({ action: 'admin_delete', id: id });
            }
        }

        // --- RENDERIZA√á√ÉO ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            allData.sort((a, b) => (a.doador !== "") ? -1 : 1);

            allData.forEach(item => {
                const tr = document.createElement('tr');
                const isTaken = item.doador && item.doador !== "";

                tr.innerHTML = `
                    <td>
                        <strong>${item.nome}</strong><br>
                        <small style="color:#888">${item.tipo === 'presente' ? 'üéÅ Presente' : 'üç© Comida'}</small>
                    </td>
                    <td>
                        ${isTaken 
                            ? `<span class="tag tag-ocupado">${item.doador}</span>` 
                            : `<span class="tag tag-livre">Livre</span>`
                        }
                    </td>
                    <td style="text-align:right">
                        ${isTaken 
                            ? `<button class="btn btn-warning" onclick="resetItem(${item.id})">Liberar</button>` 
                            : ''
                        }
                        <button class="btn btn-danger" onclick="deleteItem(${item.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = allData.length;
            document.getElementById('stat-taken').innerText = allData.filter(i => i.doador !== "").length;
            document.getElementById('stat-free').innerText = allData.filter(i => i.doador === "").length;
        }

        document.getElementById('admin-pass').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') login();
        });

        // Fun√ß√£o chamada pelo bot√£o 'Atualizar' no header
        window.refreshSheet = async function() {
            const btn = document.getElementById('update-btn');
            if (!btn) return fetchData();
            try {
                btn.disabled = true;
                const original = btn.innerText;
                btn.innerText = 'Atualizando...';
                await fetchData();
            } catch (err) {
                console.error(err);
                alert('Erro ao atualizar. Veja o console.');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Atualizar';
            }
        }

        // Fun√ß√£o para testar a conex√£o com o SCRIPT_URL e mostrar diagn√≥stico
        window.testScript = async function() {
            const url = SCRIPT_URL;
            try {
                // Abre a URL em nova aba para inspe√ß√£o manual
                window.open(url, '_blank');

                // Tenta buscar (CORS pode bloquear, mas veremos o erro no console)
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                console.log('Resposta raw:', response);
                const text = await response.text();
                console.log('Corpo da resposta:', text);
                if (response.ok) {
                    try {
                        const json = JSON.parse(text);
                        console.log('JSON recebido:', json);
                        alert('Conex√£o OK ‚Äî resposta JSON recebida. Verifique o console para detalhes.');
                    } catch (e) {
                        alert('Conectou ao endpoint, mas a resposta n√£o √© JSON v√°lido. Verifique o Apps Script. Veja console.');
                    }
                } else {
                    alert('O endpoint respondeu com status: ' + response.status + '. Veja o console para o corpo da resposta.');
                }
            } catch (e) {
                console.error('Erro ao testar SCRIPT_URL:', e);
                alert('Falha ao conectar com o endpoint. Verifique no console (F12). Poss√≠veis causas:\n- URL incorreta\n- App Script n√£o implantado como Web App p√∫blico\n- CORS bloqueando a requisi√ß√£o');
            }
        }

</script>
</body>
</html>
